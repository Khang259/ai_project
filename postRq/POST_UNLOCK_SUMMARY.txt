================================================================================
    CÆ  CHáº¾ UNLOCK KHI POST REQUEST THáº¤T Báº I
================================================================================

ğŸ¯ Tá»”NG QUAN:
------------
Khi POST request tháº¥t báº¡i sau 3 láº§n thá»­ â†’ Tá»± Ä‘á»™ng gá»­i UNLOCK message sau 60s

Ãp dá»¥ng cho:
  âœ… Regular Pairs (stable_pairs)
  âœ… Dual Pairs (stable_dual - cáº£ 2P vÃ  4P)

================================================================================

ğŸ” LOGIC (4 BÆ¯á»šC):
------------------

BÆ¯á»šC 1: Nháº­n message tá»« queue
  - Topic: "stable_pairs" hoáº·c "stable_dual"
  - Extract: pair_id, start_slot, end_slot

BÆ¯á»šC 2: Táº¡o orderId vÃ  build payload
  - orderId = {timestamp_ms}{random_salt}
  - Build payload tÃ¹y loáº¡i (pair hoáº·c dual)

BÆ¯á»šC 3: Retry 3 láº§n POST to API
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Attempt 1: POST â†’ Failed â†’ Sleep 2s â”‚
  â”‚ Attempt 2: POST â†’ Failed â†’ Sleep 2s â”‚
  â”‚ Attempt 3: POST â†’ Failed            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    Táº¤T Cáº¢ THáº¤T Báº I
        â†“
BÆ¯á»šC 4: Gá»­i unlock message sau 60s
  - Start background thread
  - Sleep 60 giÃ¢y
  - Publish "unlock_start_slot"

================================================================================

â±ï¸  TIMELINE:
-------------

T=0s:    Nháº­n message, táº¡o orderId
T=0s:    Attempt 1: POST â†’ FAILED â†’ Sleep 2s
T=2s:    Attempt 2: POST â†’ FAILED â†’ Sleep 2s
T=4s:    Attempt 3: POST â†’ FAILED
T=4s:    âœ— THáº¤T Báº I HOÃ€N TOÃ€N
         â†’ Start unlock thread (sleep 60s)
T=64s:   ğŸ”“ Publish unlock message

Tá»•ng thá»i gian: 64 giÃ¢y (tá»« nháº­n message Ä‘áº¿n unlock)

================================================================================

ğŸ”“ UNLOCK MESSAGE:
------------------

Topic: "unlock_start_slot"
Key:   start_slot (vÃ­ dá»¥: "62")

Payload:
{
  "pair_id": "62 -> 13",                    // Hoáº·c dual_id
  "start_slot": "62",
  "reason": "post_failed_after_retries",
  "timestamp": "2024-10-16T10:31:04.123456"
}

================================================================================

ğŸ“Š Báº¢NG QUYáº¾T Äá»ŠNH:
-------------------

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TrÆ°á»ng há»£p      â”‚ Retry â”‚ Káº¿t quáº£  â”‚ HÃ nh Ä‘á»™ng       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Attempt 1 OK    â”‚ 1/3   â”‚ âœ… Successâ”‚ Dá»«ng, no unlock â”‚
â”‚ Attempt 2 OK    â”‚ 2/3   â”‚ âœ… Successâ”‚ Dá»«ng, no unlock â”‚
â”‚ Attempt 3 OK    â”‚ 3/3   â”‚ âœ… Successâ”‚ Dá»«ng, no unlock â”‚
â”‚ Táº¥t cáº£ failed   â”‚ 3/3   â”‚ âŒ Failed â”‚ ğŸ”“ Unlock 60s   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================

ğŸ’¡ Táº I SAO 60 GIÃ‚Y?
-------------------

1. TrÃ¡nh spam unlock ngay láº­p tá»©c
   â†’ NgÄƒn vÃ²ng láº·p: detect â†’ POST fail â†’ unlock â†’ detect láº¡i

2. Cho phÃ©p can thiá»‡p thá»§ cÃ´ng
   â†’ Admin cÃ³ 60s Ä‘á»ƒ check/fix

3. TrÃ¡nh overload há»‡ thá»‘ng
   â†’ API cÃ³ thá»i gian recover

4. PhÃ¹ há»£p vá»›i stable time
   â†’ Stable 20s + Unlock 60s = 80s giá»¯a 2 láº§n publish

================================================================================

ğŸ¬ VÃ Dá»¤ - REGULAR PAIR:
------------------------

Input:
  pair_id: "62 -> 13"
  start_slot: "62"
  end_slot: "13"

Console log:
  ============================================================
  Xá»¬ LÃ MESSAGE Má»šI | Topic: stable_pairs | ID: 123
  ============================================================
  Báº¯t Ä‘áº§u xá»­ lÃ½ regular pair: 62 -> 13, orderId=1729085400000a1b2
  
  --- Láº§n thá»­ 1/3 ---
  [ERROR] âœ— Request timeout sau 10s
  âš  Láº§n thá»­ 1 tháº¥t báº¡i, 2 giÃ¢y trÆ°á»›c khi thá»­ láº¡i...
  
  --- Láº§n thá»­ 2/3 ---
  [ERROR] âœ— Connection error
  âš  Láº§n thá»­ 2 tháº¥t báº¡i, 2 giÃ¢y trÆ°á»›c khi thá»­ láº¡i...
  
  --- Láº§n thá»­ 3/3 ---
  [ERROR] âœ— HTTP 500
  âš  Láº§n thá»­ 3 tháº¥t báº¡i
  
  âœ— THáº¤T Báº I HOÃ€N TOÃ€N | OrderID: 1729085400000a1b2
  [UNLOCK_SCHEDULE] Sáº½ unlock start_slot=62 sau 60 giÃ¢y
  
  ... (60 giÃ¢y sau) ...
  
  [UNLOCK_SCHEDULED] ÄÃ£ gá»­i unlock message cho start_slot=62

================================================================================

ğŸ¬ VÃ Dá»¤ - DUAL 4P:
-------------------

Input:
  dual_id: "10000628-> 10000386-> 10000374-> 10000124"
  start_slot: "10000628"
  start_slot_2: "10000374"

Káº¿t quáº£:
  - Retry 3 láº§n â†’ Táº¥t cáº£ failed
  - Unlock CHá»ˆ start_slot="10000628"
  - KHÃ”NG unlock start_slot_2="10000374"

LÃ½ do:
  start_slot lÃ  Ä‘iá»ƒm xuáº¥t phÃ¡t chÃ­nh
  â†’ Chá»‰ cáº§n unlock Ä‘iá»ƒm chÃ­nh Ä‘á»ƒ trÃ¡nh stuck

================================================================================

ğŸ”§ HÃ€M QUAN TRá»ŒNG:
------------------

1. send_unlock_after_delay(queue, pair_id, start_slot, delay=60)
   - Táº¡o background thread
   - Sleep 60s
   - Publish unlock message
   - Non-blocking, daemon thread

2. main() - Retry logic
   - Loop 3 láº§n
   - Sleep 2s giá»¯a cÃ¡c attempt
   - Gá»i send_unlock_after_delay() náº¿u táº¥t cáº£ failed

================================================================================

ğŸ“ THAM Sá»:
-----------

Sá»‘ láº§n retry:        3
Delay giá»¯a retry:    2 giÃ¢y
Delay trÆ°á»›c unlock:  60 giÃ¢y
Topic unlock:        "unlock_start_slot"

================================================================================

ğŸ”„ FLOW HOÃ€N CHá»ˆNH:
-------------------

stable_pair_processor.py
  â†’ Detect pair stable
  â†’ Publish "stable_pairs"
        â†“
postAPI.py
  â†’ Subscribe message
  â†’ Retry POST 3 láº§n
  â†’ Táº¥t cáº£ failed
  â†’ Start unlock thread (60s)
  â†’ Publish "unlock_start_slot"
        â†“
roi_processor.py (hoáº·c component khÃ¡c)
  â†’ Subscribe "unlock_start_slot"
  â†’ Xá»­ lÃ½ unlock logic

================================================================================

âœ… TÃ“M Táº®T:
-----------

Khi POST tháº¥t báº¡i 3 láº§n:
  1. Log tháº¥t báº¡i
  2. Start background thread
  3. Sleep 60 giÃ¢y
  4. Publish unlock message

Má»¥c Ä‘Ã­ch:
  âœ… TrÃ¡nh pair bá»‹ stuck
  âœ… Tá»± phá»¥c há»“i khi API down
  âœ… KhÃ´ng spam detect láº¡i ngay

================================================================================

ğŸ“š TÃ€I LIá»†U CHI TIáº¾T:
---------------------

docs/README_POST_UNLOCK_MECHANISM.md - TÃ i liá»‡u Ä‘áº§y Ä‘á»§ vá»›i vÃ­ dá»¥ chi tiáº¿t

================================================================================

