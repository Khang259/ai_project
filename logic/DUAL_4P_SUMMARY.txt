================================================================================
    CÆ  CHáº¾ LOGIC PUBLISH DUAL 4-POINT (4P)
================================================================================

ðŸŽ¯ Tá»”NG QUAN:
------------
Dual 4-Point = 4 QR codes (2 start + 2 end)
- start_qr + end_qrs (cáº·p chÃ­nh)
- start_qr_2 + end_qrs_2 (cáº·p phá»¥)

================================================================================

ðŸ“‹ Cáº¤U HÃŒNH:
-----------
{
  "start_qr": 10000628,      // Start 1 (Ä‘iá»ƒm xuáº¥t phÃ¡t chÃ­nh)
  "end_qrs": 10000386,       // End 1 (Ä‘iá»ƒm Ä‘áº¿n chÃ­nh)
  "start_qr_2": 10000374,    // Start 2 (Ä‘iá»ƒm xuáº¥t phÃ¡t phá»¥)
  "end_qrs_2": 10000124      // End 2 (Ä‘iá»ƒm Ä‘áº¿n phá»¥)
}

================================================================================

ðŸ” LOGIC KIá»‚M TRA (ÄÆ N GIáº¢N HÃ“A):
----------------------------------

BÆ¯á»šC 1: LUÃ”N XÃ‰T Cáº¶P CHÃNH TRÆ¯á»šC
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ start_qr = shelf (stable â‰¥ 20s) ?               â”‚
  â”‚ end_qrs = empty (stable â‰¥ 20s) ?                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
       âŒ KHÃ”NG â†’ Dá»ªNG (khÃ´ng publish)
              â†“
          âœ… CÃ“ (cáº·p chÃ­nh OK)
              â†“
BÆ¯á»šC 2: XÃ‰T start_qr_2
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ start_qr_2 = shelf (stable â‰¥ 20s) ?             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
      â”‚       â”‚       â”‚
    âœ… YES  âŒ NO   âš ï¸  KhÃ´ng stable
      â”‚       â”‚       â”‚
  Pub 4P   Kiá»ƒm tra  KhÃ´ng pub
            empty?
              â”‚
          âœ… YES
              â”‚
          Pub 2P

âœ… LOGIC ÄÆ N GIáº¢N:
  1. Cáº·p chÃ­nh (start_qr, end_qrs) = (shelf, empty) â†’ OK
  2. start_qr_2 == shelf â†’ Pub 4P
  3. start_qr_2 == empty â†’ Pub 2P
  4. start_qr_2 khÃ´ng stable â†’ KhÃ´ng pub

================================================================================

ðŸ“Š Báº¢NG QUYáº¾T Äá»ŠNH:
-------------------

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ start_qr   â”‚ end_qrs  â”‚ start_qr_2  â”‚ Káº¿t quáº£       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ empty   â”‚ -        â”‚ -           â”‚ âŒ KHÃ”NG pub  â”‚
â”‚ âœ… shelf   â”‚ âŒ shelf â”‚ -           â”‚ âŒ KHÃ”NG pub  â”‚
â”‚ âœ… shelf   â”‚ âœ… empty â”‚ âœ… shelf    â”‚ ðŸŽ‰ PUB 4P     â”‚
â”‚ âœ… shelf   â”‚ âœ… empty â”‚ âŒ empty    â”‚ âœ… PUB 2P     â”‚
â”‚ âœ… shelf   â”‚ âœ… empty â”‚ âŒ KhÃ´ng cÃ³ â”‚ âœ… PUB 2P     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

================================================================================

ðŸ“¦ PAYLOAD DUAL 4P:
------------------

Topic: "stable_dual"

Payload:
{
  "dual_id": "10000628-> 10000386-> 10000374-> 10000124",
  "start_slot": "10000628",      â† Start 1
  "end_slot": "10000386",        â† End 1
  "start_slot_2": "10000374",    â† Start 2
  "end_slot_2": "10000124",      â† End 2
  "stable_since": "2024-10-16T10:30:45.123Z"
}

================================================================================

â±ï¸  ÄIá»€U KIá»†N THá»œI GIAN:
------------------------

Stable Time:     20 giÃ¢y (máº·c Ä‘á»‹nh)
Cooldown Time:   10 giÃ¢y
Duplicate Check: Theo phÃºt (YYYY-MM-DD HH:MM)

================================================================================

ðŸŽ¬ VÃ Dá»¤ TIMELINE:
-----------------

T=0s:   10000628=empty, 10000386=shelf, 10000374=empty
        â†’ ChÆ°a pub (start_qr chÆ°a cÃ³ hÃ ng)

T=30s:  10000628=shelf(20s), 10000386=shelf
        â†’ ChÆ°a pub (end_qrs khÃ´ng empty)

T=50s:  10000628=shelf(40s)âœ…, 10000386=empty(20s)âœ…, 10000374=empty
        â†’ Cáº¶P CHÃNH OK!
        â†’ start_qr_2=empty â†’ PUB 2P

T=80s:  10000628=shelf(70s)âœ…, 10000386=empty(50s)âœ…, 10000374=shelf(20s)âœ…
        â†’ Cáº¶P CHÃNH OK!
        â†’ start_qr_2=shelf â†’ ðŸŽ‰ PUB 4P!

================================================================================

ðŸ” BLOCKING SYSTEM:
------------------

Sau khi publish 4P:

1. BLOCK start_qr
   - Topic: "dual_block"
   - Action: "block"
   - LÃ½ do: TrÃ¡nh phÃ¡t hiá»‡n láº¡i cáº·p nÃ y

2. Monitor end_qrs
   - Chá» end_qrs = shelf (stable 20s)

3. UNBLOCK start_qr
   - Topic: "dual_unblock"
   - Action: "unblock"
   - LÃ½ do: "end_qrs_stable_shelf"

================================================================================

ðŸ’¡ Táº I SAO KHÃ”NG KIá»‚M TRA end_qrs_2?
------------------------------------

1. end_qrs_2 lÃ  Ä‘iá»ƒm Ä‘áº¿n chung cho nhiá»u route
2. KhÃ´ng cáº§n thiáº¿t pháº£i trá»‘ng ngay láº­p tá»©c
3. TÄƒng tÃ­nh linh hoáº¡t cá»§a há»‡ thá»‘ng
4. Logic Ä‘Æ¡n giáº£n hÆ¡n

Chá»‰ cáº§n:
  âœ… start_qr = cÃ³ hÃ ng
  âœ… end_qrs = trá»‘ng
  âœ… start_qr_2 = cÃ³ hÃ ng
  â†’ OK Ä‘á»ƒ publish 4P!

================================================================================

ðŸš€ FLOW SAU KHI PUBLISH:
------------------------

PUBLISH 4P
    â†“
postAPI.py nháº­n message
    â†“
Táº¡o orderId (timestamp+random)
    â†“
Build payload: taskPath = "start,end,start_2,end_2"
    â†“
POST to API
    â†“
AMR/Robot nháº­n nhiá»‡m vá»¥ 4-point

================================================================================

ðŸ” DEBUG:
--------

Console:
  [PAIR_LOGIC] start_qr=10000628 stable shelf âœ…
  [PAIR_LOGIC] end_qrs=10000386 stable empty âœ…
  [PAIR_LOGIC] start_qr_2=10000374 stable shelf âœ…
  [PAIR_LOGIC] â†’ Publishing 4-POINT dual

Log file:
  STABLE_DUAL_4P_PUBLISHED: dual_id=10000628-> 10000386-> 10000374-> 10000124

Block:
  DUAL_BLOCK_PUBLISHED: start_qr=10000628, action=block

Unblock:
  DUAL_UNBLOCK_PUBLISHED: start_qr=10000628, reason=end_qrs_stable_shelf

================================================================================

âœ… CÃ”NG THá»¨C NGáº®N Gá»ŒN:
----------------------

IF start_qr = shelf (â‰¥20s)
AND end_qrs = empty (â‰¥20s)
AND start_qr_2 = shelf (â‰¥20s)
THEN
    â†’ PUBLISH DUAL 4-POINT

KhÃ´ng cáº§n kiá»ƒm tra end_qrs_2!

================================================================================

ðŸ“š TÃ€I LIá»†U CHI TIáº¾T:
---------------------

docs/README_DUAL_4P_LOGIC.md - TÃ i liá»‡u Ä‘áº§y Ä‘á»§ vá»›i vÃ­ dá»¥ chi tiáº¿t

================================================================================

